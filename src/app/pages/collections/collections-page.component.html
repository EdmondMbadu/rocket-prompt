<ng-container *ngIf="profileLoaded(); else loading">
  <div class="min-h-screen bg-white text-slate-900">
    <!-- TOP BAR -->
    <header class="bg-white/95 backdrop-blur-xl border-b-2 border-black/5 shadow-md sticky top-0 z-40">
      <div class="mx-auto max-w-6xl px-4 pb-6 pt-5 sm:px-6 lg:px-8">
        <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
          <!-- Brand -->
          <div class="flex items-center gap-3 text-slate-900">
            <button type="button" (click)="navigateToHomeOrLanding()" class="flex items-center hover:opacity-80 transition-opacity cursor-pointer">
              <img src="assets/rocket-logo.png" alt="Rocket Prompt Logo" class="h-14 w-auto" />
            </button>
          </div>

          <!-- Actions -->
          <div class="flex items-center justify-end gap-3 self-end sm:gap-5">
            <ng-container *ngIf="showCreateButton()">
              <button type="button" (click)="openCreateCollectionModal()"
                class="inline-flex items-center gap-2 rounded-xl bg-white border-2 border-[#DC2626]/30 px-6 py-2.5 text-sm font-bold text-[#DC2626] shadow-sm transition-all duration-200 hover:bg-[#DC2626] hover:text-white hover:border-[#DC2626] hover:shadow-md"
                [disabled]="profile() && availablePrompts().length === 0">
                <span class="text-base">ï¼‹</span>
                <ng-container *ngIf="profile(); else signInToCreate">
                  New Collection
                </ng-container>
              </button>
              <ng-template #signInToCreate>
                <span>Sign in to create</span>
              </ng-template>
            </ng-container>

            <ng-container *ngIf="profile(); else guestActions">
              <app-navbar [profile]="profile()" />
            </ng-container>
            <ng-template #guestActions>
              <button type="button"
                class="inline-flex items-center gap-2 rounded-xl border border-slate-300 bg-white px-4 py-2 text-sm font-semibold text-slate-600 transition hover:border-slate-400 hover:bg-slate-50"
                (click)="goToAuth()">
                Sign in
              </button>
            </ng-template>
          </div>
        </div>

        <!-- Desktop search -->
        <div class="mt-6 hidden sm:block">
          <label class="group relative flex w-full items-center rounded-2xl bg-white border-2 border-black/10 shadow-md hover:border-[#DC2626]/30 transition-all duration-200">
            <svg aria-hidden="true" viewBox="0 0 24 24" class="mx-4 h-5 w-5 text-slate-400 group-focus-within:text-[#DC2626] transition-colors">
              <path d="M21 21l-4.35-4.35m1.68-4.83a6.51 6.51 0 11-13.02 0 6.51 6.51 0 0113.02 0z" fill="none"
                stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <input type="search"
              class="w-full rounded-2xl bg-white py-3.5 pr-4 text-[15px] font-medium text-black placeholder:text-slate-400 focus:outline-none focus:border-[#DC2626] focus:ring-2 focus:ring-[#DC2626]/20"
              [placeholder]="searchPlaceholder()" [value]="searchTerm()"
              (input)="onSearch(($any($event.target)).value)" />
          </label>
        </div>
      </div>

      <!-- Mobile search -->
      <div class="mx-auto block max-w-6xl px-4 pb-4 sm:hidden sm:px-6 lg:px-8">
        <label class="group relative flex w-full items-center rounded-2xl bg-white border-2 border-black/10 shadow-md hover:border-[#DC2626]/30 transition-all duration-200">
          <svg aria-hidden="true" viewBox="0 0 24 24" class="mx-4 h-5 w-5 text-slate-400 group-focus-within:text-[#DC2626] transition-colors">
            <path d="M21 21l-4.35-4.35m1.68-4.83a6.51 6.51 0 11-13.02 0 6.51 6.51 0 0113.02 0z" fill="none"
              stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          <input type="search"
            class="w-full rounded-2xl bg-white py-3.5 pr-4 text-[15px] font-medium text-black placeholder:text-slate-400 focus:outline-none focus:border-[#DC2626] focus:ring-2 focus:ring-[#DC2626]/20"
            [placeholder]="searchPlaceholder()" [value]="searchTerm()"
            (input)="onSearch(($any($event.target)).value)" />
        </label>
      </div>
    </header>

    <!-- Join Banner for non-logged-in users -->
    <div *ngIf="!isLoggedIn()" class="bg-white border-b border-slate-200 shadow-sm">
      <div class="mx-auto max-w-6xl px-4 py-6 sm:px-6 lg:px-8 sm:py-7">
        <div class="flex items-center justify-between gap-4 flex-wrap">
          <div class="flex items-center gap-4 flex-1 min-w-0">
            <div class="flex-shrink-0">
              <span class="text-3xl sm:text-4xl">ðŸš€</span>
            </div>
            <div class="flex-1 min-w-0">
              <h3
                class="text-lg sm:text-xl font-bold leading-tight bg-gradient-to-r from-[#DC2626] to-[#EF4444] bg-clip-text text-transparent">
                Join RocketPrompt.io For Free
              </h3>
              <p class="text-sm sm:text-base text-slate-700 font-medium leading-tight mt-1">
                Save your favorite prompts and create collections
              </p>
            </div>
          </div>
          <button type="button" (click)="navigateToSignUp()"
            class="flex-shrink-0 inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-[#DC2626] to-[#EF4444] text-white px-6 py-3 sm:px-7 sm:py-3.5 text-sm sm:text-base font-bold shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 active:scale-95">
            <span>Get Started</span>
            <svg class="h-4 w-4 sm:h-5 sm:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <main class="mx-auto max-w-6xl px-4 pb-16 sm:px-6 lg:px-8" [class.pt-8]="!isLoggedIn()" [class.pt-6]="isLoggedIn()">
      <div *ngIf="loadCollectionsError()"
        class="mb-6 rounded-2xl border border-red-200 bg-red-50 px-5 py-4 text-sm text-red-700 shadow-sm">
        {{ loadCollectionsError() }}
      </div>

      <ng-container *ngIf="isLoadingCollections(); else collectionsContent">
        <div class="grid gap-8 md:grid-cols-2 xl:grid-cols-3">
          <div *ngFor="let skeleton of [1, 2, 3]" class="rounded-3xl border-2 border-black/5 bg-white p-6 shadow-lg animate-pulse">
            <div class="h-7 w-28 rounded-full bg-gradient-to-r from-slate-200 to-slate-100"></div>
            <div class="mt-5 h-6 w-3/4 rounded-lg bg-gradient-to-r from-slate-200 to-slate-100"></div>
            <div class="mt-3 h-4 w-full rounded-lg bg-gradient-to-r from-slate-200/80 to-slate-100/80"></div>
            <div class="mt-2 h-4 w-11/12 rounded-lg bg-gradient-to-r from-slate-200/60 to-slate-100/60"></div>
            <div class="mt-6 h-28 rounded-2xl bg-gradient-to-br from-slate-100 to-slate-50"></div>
            <div class="mt-6 flex justify-end gap-2">
              <div class="h-9 w-9 rounded-full bg-gradient-to-r from-slate-200 to-slate-100"></div>
              <div class="h-9 w-9 rounded-full bg-gradient-to-r from-slate-200 to-slate-100"></div>
            </div>
          </div>
        </div>
      </ng-container>

      <ng-template #collectionsContent>
        <ng-container *ngIf="filteredCollections().length > 0; else emptyState">
          <div class="grid gap-8 md:grid-cols-2 xl:grid-cols-3">
            <article *ngFor="let collection of filteredCollections(); trackBy: trackCollectionById"
              class="group flex cursor-pointer flex-col rounded-3xl border-2 border-black/5 bg-white overflow-hidden shadow-lg transition-all duration-300 hover:shadow-2xl hover:shadow-red-500/10 hover:-translate-y-2 hover:border-[#DC2626]/20"
              (click)="navigateToCollection(collection)">
              <!-- Hero Image Background -->
              <div *ngIf="collection.heroImageUrl" 
                   class="relative h-56 w-full overflow-hidden"
                   [style.background-image]="'url(' + collection.heroImageUrl + ')'"
                   [style.background-size]="'cover'"
                   [style.background-position]="'center'">
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-black/20"></div>
                <div class="absolute top-4 left-4 z-10">
                  <span class="inline-flex items-center rounded-full bg-white/95 backdrop-blur-sm border-2 border-white/50 px-3 py-1.5 text-xs font-bold capitalize text-slate-700 shadow-lg">
                    {{ collection.tagLabel }}
                  </span>
                </div>
                <div class="absolute bottom-0 left-0 right-0 p-6 z-10">
                  <h3 class="text-2xl font-black tracking-tight text-white drop-shadow-2xl">
                    {{ collection.name }}
                  </h3>
                </div>
              </div>

              <!-- Content Section -->
              <div class="flex flex-col p-6" [class.pt-4]="collection.heroImageUrl">
                <!-- Tag and Title (when no hero image) -->
                <ng-container *ngIf="!collection.heroImageUrl">
                  <span class="w-fit rounded-full bg-white border-2 border-[#DC2626]/30 px-3 py-1.5 text-xs font-bold capitalize text-[#DC2626] shadow-sm">
                    {{ collection.tagLabel }}
                  </span>
                  <h3 class="mt-4 text-2xl font-black tracking-tight text-slate-900 group-hover:text-[#DC2626] transition-colors duration-200">
                    {{ collection.name }}
                  </h3>
                </ng-container>

                <p class="mt-3 text-sm font-semibold text-slate-600">
                  {{ collection.promptCount === 1 ? '1 prompt' : collection.promptCount + ' prompts' }}
                </p>

                <div class="mt-6 mt-auto flex items-center justify-between text-sm">
                  <button type="button" class="collection-bookmark-button"
                    [attr.aria-pressed]="isCollectionBookmarked(collection.id)"
                    [disabled]="isCollectionBookmarking(collection.id)"
                    (click)="toggleCollectionBookmark(collection, $event)" data-tooltip="Add to saved collections">
                    <svg aria-hidden="true" viewBox="0 0 24 24" class="h-4 w-4">
                      <path [attr.fill]="isCollectionBookmarked(collection.id) ? '#dc2626' : 'none'"
                        [attr.stroke]="isCollectionBookmarked(collection.id) ? '#dc2626' : 'currentColor'"
                        stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"
                        d="M6 3h12a1 1 0 011 1v16.382a.5.5 0 01-.79.407L12 17.25l-6.21 3.539a.5.5 0 01-.79-.407V4a1 1 0 011-1z" />
                    </svg>
                    <span class="font-bold">{{ collection.bookmarkCount }}</span>
                  </button>

                  <span class="flex items-center gap-2 font-semibold text-slate-600 group-hover:text-[#DC2626] transition-colors duration-200">
                    <span>View collection</span>
                    <svg aria-hidden="true" viewBox="0 0 24 24" class="h-4 w-4">
                      <path d="M9 5l7 7-7 7" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                        stroke-linejoin="round" />
                    </svg>
                  </span>
                </div>
              </div>
            </article>
          </div>
        </ng-container>
      </ng-template>
    </main>

    <app-collection-modal
      [isOpen]="newCollectionModalOpen()"
      [isSaving]="isSavingCollection()"
      [form]="collectionForm"
      title="New Collection"
      description="Group your favorite prompts into a reusable set."
      customUrlPrefix="rocketprompt.io/collection/"
      [customUrlError]="customUrlError()"
      [isCheckingCustomUrl]="isCheckingCustomUrl()"
      [promptSearchTerm]="promptSearchTerm()"
      promptSearchPlaceholder="Search prompts by title or tag..."
      [showPromptSearch]="!isLoadingPrompts() && !loadPromptsError() && availablePrompts().length > 0"
      [prompts]="filteredPrompts()"
      [selectedPromptIds]="collectionForm.controls.promptIds.value"
      [chatbotOptions]="chatbotOptions"
      [defaultAi]="collectionDefaultAi()"
      [isLoadingPrompts]="isLoadingPrompts()"
      [promptLoadError]="loadPromptsError()"
      [enableBranding]="true"
      [brandingSectionExpanded]="brandingSectionExpanded()"
      brandSectionDescription="Add your company logo, link, and a short description to brand this collection."
      [brandLogoUrl]="brandLogoUrl()"
      [uploadingBrandLogo]="uploadingBrandLogo()"
      [brandLogoUploadError]="brandLogoUploadError()"
      [brandSubtextWordCount]="brandSubtextWordCount()"
      [formError]="collectionFormError()"
      [disableSubmit]="availablePrompts().length === 0 || brandSubtextWordCount() > 50"
      submitButtonLabel="Save Collection"
      cancelButtonLabel="Cancel"
      [noPromptsTitle]="profile() ? 'You have no prompts yet' : 'Sign in to create prompts'"
      [noPromptsDescription]="profile() ? 'Create prompts first to build a collection' : 'Build your first collection'"
      (close)="closeCreateCollectionModal()"
      (formSubmit)="submitCollectionForm()"
      (customUrlInput)="onCustomUrlInput($event)"
      (promptSearchChange)="onPromptSearch($event)"
      (promptSearchCleared)="promptSearchTerm.set('')"
      (promptSelectionToggle)="togglePromptSelection($event)"
      (defaultAiChange)="setCollectionDefaultAi($event)"
      (brandLogoSelected)="onBrandLogoSelected($event)"
      (brandLogoRemoved)="deleteBrandLogo()"
      (toggleBrandingSection)="brandingSectionExpanded.set(!brandingSectionExpanded())"
    ></app-collection-modal>
  </div>
</ng-container>

<ng-template #emptyState>
  <div
    class="mx-auto max-w-6xl rounded-3xl border-2 border-dashed border-black/10 bg-gradient-to-br from-white to-slate-50/50 px-10 py-20 text-center shadow-lg">
    <div class="text-6xl mb-6">ðŸ“š</div>
    <p class="text-2xl font-black text-black">{{ emptyStateTitle() }}</p>
    <p class="mt-3 max-w-md mx-auto text-base text-black/60 leading-relaxed">
      {{ emptyStateDescription() }}
    </p>
    <button *ngIf="showCreateButton()" type="button" (click)="openCreateCollectionModal()"
      class="mt-6 inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-[#DC2626] to-[#B91C1C] text-white px-6 py-3 text-sm font-bold shadow-lg hover:shadow-xl hover:shadow-red-500/40 hover:scale-105 transition-all duration-200">
      <span class="text-base">ï¼‹</span>
      Create Your First Collection
    </button>
  </div>
</ng-template>

<ng-template #loading>
  <div role="status" aria-live="polite"
    class="fixed inset-0 z-50 flex items-center justify-center bg-white text-slate-900">
    <div class="w-full max-w-sm px-6 py-8 text-center">
      <div class="mx-auto mb-6 h-12 w-12 animate-spin rounded-full border-4 border-slate-200 border-t-[#DC2626]"></div>
      <p class="text-xl font-semibold">Loadingâ€¦</p>
      <p class="mt-2 text-sm opacity-80">Preparing your collections</p>
    </div>
  </div>
</ng-template>
