<ng-container *ngIf="organizationLoaded(); else loading">
  <div class="min-h-screen bg-white text-slate-900">
    <!-- TOP BAR -->
    <header class="bg-white/95 backdrop-blur-xl border-b-2 border-black/5 shadow-md sticky top-0 z-40 w-full">
      <div class="mx-auto max-w-6xl px-2 pb-3 pt-3 sm:px-3 sm:pb-4 sm:pt-4 md:px-4 md:pb-6 md:pt-5 lg:px-8 w-full overflow-x-hidden">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between sm:gap-4 w-full min-w-0">
          <!-- Brand -->
          <div class="flex items-center gap-2 sm:gap-3 text-slate-900 flex-shrink-0">
            <button type="button" (click)="navigateToHomeOrLanding()" class="flex items-center hover:opacity-80 transition-opacity cursor-pointer">
              <img src="assets/rocket-logo.png" alt="Rocket Prompt Logo" class="h-10 w-auto sm:h-14" />
            </button>
          </div>

          <!-- Actions -->
          <div class="flex items-center justify-end gap-2 self-end sm:gap-3 sm:gap-5 flex-shrink-0">
            <button *ngIf="currentUserProfile() && isViewingOwnOrganization()" type="button" (click)="openCreateCollectionModal()"
              class="inline-flex items-center gap-1.5 rounded-xl bg-white border-2 border-[#DC2626]/30 px-3 py-2 text-xs font-bold text-[#DC2626] shadow-sm transition-all duration-200 hover:bg-[#DC2626] hover:text-white hover:border-[#DC2626] hover:shadow-md sm:gap-2 sm:px-6 sm:py-2.5 sm:text-sm">
              <span class="text-sm sm:text-base">＋</span>
              <span class="hidden min-[375px]:inline">New Collection</span>
              <span class="min-[375px]:hidden">Collection</span>
            </button>
            <button *ngIf="currentUserProfile() && isViewingOwnOrganization()" type="button" (click)="openCreatePromptModal()"
              class="inline-flex items-center gap-1.5 rounded-xl bg-white border-2 border-[#DC2626]/30 px-3 py-2 text-xs font-bold text-[#DC2626] shadow-sm transition-all duration-200 hover:bg-[#DC2626] hover:text-white hover:border-[#DC2626] hover:shadow-md sm:gap-2 sm:px-6 sm:py-2.5 sm:text-sm">
              <span class="text-sm sm:text-base">＋</span>
              <span class="hidden min-[375px]:inline">New Prompt</span>
              <span class="min-[375px]:hidden">New</span>
            </button>
            <ng-container *ngIf="currentUserProfile(); else guestActions">
              <app-navbar [profile]="currentUserProfile()" />
            </ng-container>
            <ng-template #guestActions>
              <button type="button"
                class="inline-flex items-center gap-2 rounded-xl border border-slate-300 bg-white px-4 py-2 text-sm font-semibold text-slate-600 transition hover:border-slate-400 hover:bg-slate-50"
                (click)="router.navigate(['/auth'])">
                Sign in
              </button>
            </ng-template>
          </div>
        </div>
      </div>
    </header>

    <!-- ORGANIZATION HEADER -->
    <ng-container *ngIf="organization(); else notFound">
      <section class="mx-auto max-w-6xl px-4 pt-8 sm:px-6 lg:px-8">
        <!-- Cover Image -->
        <div class="relative group">
          <div *ngIf="organization()!.coverImageUrl" 
            class="relative h-64 w-full rounded-2xl overflow-hidden mb-6 border-2 border-slate-200">
            <img [src]="organization()!.coverImageUrl" 
              [alt]="organization()!.name + ' cover image'"
              class="w-full h-full object-cover" />
            <!-- Edit overlay for cover image -->
            <div *ngIf="canEditOrganization() && !uploadingCover()"
              class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center pointer-events-none">
              <div class="text-white text-center px-3">
                <svg aria-hidden="true" viewBox="0 0 24 24" class="h-8 w-8 mx-auto mb-1" fill="none"
                  stroke="currentColor" stroke-width="2.5">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <p class="text-xs font-semibold">{{ organization()!.coverImageUrl ? 'Change' : 'Add' }} Cover</p>
              </div>
            </div>
            <!-- Loading indicator -->
            <div *ngIf="uploadingCover()"
              class="absolute inset-0 flex items-center justify-center bg-black/60 rounded-2xl backdrop-blur-sm">
              <div class="text-center">
                <svg aria-hidden="true" viewBox="0 0 24 24" class="h-8 w-8 animate-spin text-white mx-auto mb-2">
                  <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2" opacity="0.25">
                  </circle>
                  <path d="M21 12a9 9 0 00-9-9" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round">
                  </path>
                </svg>
                <p class="text-xs font-semibold text-white">Uploading...</p>
              </div>
            </div>
          </div>
          <div *ngIf="!organization()!.coverImageUrl"
            class="relative h-64 w-full rounded-2xl bg-gradient-to-br from-slate-100 to-slate-200 mb-6 border-2 border-slate-200 group">
            <!-- Edit overlay for cover image when no image exists -->
            <div *ngIf="canEditOrganization() && !uploadingCover()"
              class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center pointer-events-none">
              <div class="text-slate-700 text-center px-3">
                <svg aria-hidden="true" viewBox="0 0 24 24" class="h-8 w-8 mx-auto mb-1" fill="none"
                  stroke="currentColor" stroke-width="2.5">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <p class="text-xs font-semibold">Add Cover Image</p>
              </div>
            </div>
          </div>
          <!-- Cover image upload button -->
          <label *ngIf="canEditOrganization()"
            class="absolute top-4 right-4 z-10 inline-flex items-center gap-2 rounded-xl bg-white/95 backdrop-blur-sm border-2 border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-white hover:border-[#DC2626] hover:text-[#DC2626] transition-all cursor-pointer shadow-lg"
            [class.opacity-50]="uploadingCover()"
            [class.cursor-not-allowed]="uploadingCover()">
            <input type="file" accept="image/*" class="hidden" (change)="onCoverSelected($event)"
              [disabled]="uploadingCover()" />
            <svg aria-hidden="true" viewBox="0 0 24 24" class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2.5">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <span>{{ organization()!.coverImageUrl ? 'Change' : 'Add' }} Cover</span>
          </label>
          <p *ngIf="coverError()" class="absolute bottom-4 left-4 right-4 rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700 z-10">
            {{ coverError() }}
          </p>
        </div>

        <!-- Organization Info -->
        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-6 mb-8">
          <div class="flex items-center gap-5 w-full sm:w-auto justify-center sm:justify-start">
            <div class="relative -mt-16 sm:-mt-20 group">
              <div *ngIf="organization()!.logoUrl" 
                class="h-32 w-32 rounded-full bg-white border-4 border-white shadow-xl overflow-hidden">
                <img [src]="organization()!.logoUrl" 
                  [alt]="organization()!.name"
                  class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" />
                <!-- Hover overlay for logo -->
                <div *ngIf="canEditOrganization() && !uploadingLogo()"
                  class="absolute inset-0 rounded-full bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center pointer-events-none">
                  <div class="text-white text-center px-3">
                    <svg aria-hidden="true" viewBox="0 0 24 24" class="h-6 w-6 mx-auto mb-1" fill="none"
                      stroke="currentColor" stroke-width="2.5">
                      <path stroke-linecap="round" stroke-linejoin="round"
                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <p class="text-xs font-semibold">{{ organization()!.logoUrl ? 'Change' : 'Add' }} Logo</p>
                  </div>
                </div>
                <!-- Loading indicator -->
                <div *ngIf="uploadingLogo()"
                  class="absolute inset-0 flex items-center justify-center bg-black/60 rounded-full backdrop-blur-sm">
                  <div class="text-center">
                    <svg aria-hidden="true" viewBox="0 0 24 24" class="h-8 w-8 animate-spin text-white mx-auto mb-2">
                      <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2" opacity="0.25">
                      </circle>
                      <path d="M21 12a9 9 0 00-9-9" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round">
                      </path>
                    </svg>
                    <p class="text-xs font-semibold text-white">Uploading...</p>
                  </div>
                </div>
              </div>
              <div *ngIf="!organization()!.logoUrl"
                class="h-32 w-32 rounded-full bg-gradient-to-br from-[#DC2626] to-[#B91C1C] flex items-center justify-center text-white text-4xl font-black shadow-xl border-4 border-white">
                {{ getOrganizationInitials(organization()) }}
                <!-- Hover overlay for logo when no image -->
                <div *ngIf="canEditOrganization() && !uploadingLogo()"
                  class="absolute inset-0 rounded-full bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center pointer-events-none">
                  <div class="text-white text-center px-3">
                    <svg aria-hidden="true" viewBox="0 0 24 24" class="h-6 w-6 mx-auto mb-1" fill="none"
                      stroke="currentColor" stroke-width="2.5">
                      <path stroke-linecap="round" stroke-linejoin="round"
                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <p class="text-xs font-semibold">Add Logo</p>
                  </div>
                </div>
                <!-- Loading indicator -->
                <div *ngIf="uploadingLogo()"
                  class="absolute inset-0 flex items-center justify-center bg-black/60 rounded-full backdrop-blur-sm">
                  <div class="text-center">
                    <svg aria-hidden="true" viewBox="0 0 24 24" class="h-8 w-8 animate-spin text-white mx-auto mb-2">
                      <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2" opacity="0.25">
                      </circle>
                      <path d="M21 12a9 9 0 00-9-9" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round">
                      </path>
                    </svg>
                    <p class="text-xs font-semibold text-white">Uploading...</p>
                  </div>
                </div>
              </div>
              <!-- Logo upload button -->
              <label *ngIf="canEditOrganization()"
                class="absolute -bottom-2 -right-2 z-10 inline-flex items-center justify-center rounded-full bg-white border-2 border-slate-300 p-2 text-slate-700 hover:bg-slate-50 hover:border-[#DC2626] hover:text-[#DC2626] transition-all cursor-pointer shadow-lg"
                [class.opacity-50]="uploadingLogo()"
                [class.cursor-not-allowed]="uploadingLogo()"
                [attr.data-tooltip]="organization()!.logoUrl ? 'Change logo' : 'Add logo'">
                <input type="file" accept="image/*" class="hidden" (change)="onLogoSelected($event)"
                  [disabled]="uploadingLogo()" />
                <svg aria-hidden="true" viewBox="0 0 24 24" class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2.5">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
              </label>
              <p *ngIf="logoError()" class="absolute -bottom-8 left-0 right-0 text-center text-xs text-red-600 whitespace-nowrap">
                {{ logoError() }}
              </p>
            </div>
          </div>
          <div class="flex-1 min-w-0 w-full sm:w-auto text-center sm:text-left">
            <!-- Name -->
              <div *ngIf="!editingName(); else editingNameTemplate">
                <div class="flex items-center gap-3 justify-center sm:justify-start">
                  <h1 class="text-4xl font-black tracking-tight text-slate-900">{{ organization()!.name }}</h1>
                  <button *ngIf="canEditOrganization()" 
                    type="button"
                    (click)="startEditingName()"
                    class="p-1.5 rounded-lg hover:bg-slate-100 transition-colors"
                    title="Edit name">
                    <svg aria-hidden="true" viewBox="0 0 24 24" class="h-5 w-5 text-slate-500" fill="none" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                  </button>
                </div>
              </div>
              <ng-template #editingNameTemplate>
                <form [formGroup]="nameForm" (ngSubmit)="saveName()" class="flex items-center gap-2">
                  <input type="text" 
                    formControlName="name"
                    class="flex-1 text-4xl font-black tracking-tight text-slate-900 bg-transparent border-b-2 border-[#DC2626] focus:outline-none focus:border-[#DC2626]"
                    [class.border-red-300]="nameForm.controls.name.invalid && nameForm.controls.name.touched" />
                  <button type="submit"
                    [disabled]="isSaving() || nameForm.invalid"
                    class="p-1.5 rounded-lg bg-green-500 text-white hover:bg-green-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    title="Save">
                    <svg aria-hidden="true" viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                    </svg>
                  </button>
                  <button type="button"
                    (click)="cancelEditingName()"
                    [disabled]="isSaving()"
                    class="p-1.5 rounded-lg bg-slate-200 text-slate-700 hover:bg-slate-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    title="Cancel">
                    <svg aria-hidden="true" viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </form>
                <p *ngIf="nameForm.controls.name.invalid && nameForm.controls.name.touched" class="mt-1 text-xs text-red-600">
                  Name is required and must be at least 2 characters.
                </p>
              </ng-template>

              <div *ngIf="organization()!.username" class="flex items-center gap-2 mt-2">
                <p class="text-base font-semibold text-slate-600">
                  @{{ organization()!.username }}
                </p>
                <button type="button" 
                  class="btn-copy-org-url" 
                  (click)="copyOrganizationUrl()"
                  title="Copy organization URL">
                  <ng-container *ngIf="organizationUrlCopied(); else copyIconOrg">
                    <svg aria-hidden="true" viewBox="0 0 24 24" class="copy-icon-org" fill="none"
                      stroke="currentColor" stroke-width="2.2">
                      <path d="M20 6L9 17l-5-5" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                  </ng-container>
                  <ng-template #copyIconOrg>
                    <svg aria-hidden="true" viewBox="0 0 24 24" class="copy-icon-org" fill="none"
                      stroke="currentColor" stroke-width="1.8">
                      <rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" stroke-linecap="round"
                        stroke-linejoin="round" />
                    </svg>
                  </ng-template>
                </button>
              </div>

              <!-- Description -->
              <div class="mt-3 max-w-2xl">
                <div *ngIf="!editingDescription(); else editingDescriptionTemplate">
                  <div *ngIf="organization()!.description; else noDescription">
                    <p class="text-base text-slate-600">
                      {{ showFullDescription() ? organization()!.description : truncatedDescription() }}
                    </p>
                    <button *ngIf="descriptionWordCount() > 50 && !showFullDescription()"
                      type="button"
                      (click)="toggleDescription()"
                      class="mt-2 text-sm font-semibold text-[#DC2626] hover:underline">
                      Show more
                    </button>
                    <button *ngIf="showFullDescription() && descriptionWordCount() > 50"
                      type="button"
                      (click)="toggleDescription()"
                      class="mt-2 text-sm font-semibold text-[#DC2626] hover:underline">
                      Show less
                    </button>
                    <button *ngIf="canEditOrganization()"
                      type="button"
                      (click)="startEditingDescription()"
                      class="ml-3 text-sm font-semibold text-slate-500 hover:text-[#DC2626] hover:underline">
                      Edit
                    </button>
                  </div>
                  <ng-template #noDescription>
                    <p class="text-base text-slate-400 italic">No description provided.</p>
                    <button *ngIf="canEditOrganization()"
                      type="button"
                      (click)="startEditingDescription()"
                      class="mt-2 text-sm font-semibold text-[#DC2626] hover:underline">
                      Add description
                    </button>
                  </ng-template>
                </div>
                <ng-template #editingDescriptionTemplate>
                  <form [formGroup]="descriptionForm" (ngSubmit)="saveDescription()" class="space-y-2">
                    <textarea 
                      formControlName="description"
                      rows="4"
                      class="w-full text-base text-slate-600 bg-white border-2 border-[#DC2626] rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#DC2626]/40 resize-none description-textarea"
                      [class.border-red-300]="descriptionForm.controls.description.invalid && descriptionForm.controls.description.touched"
                      placeholder="Tell us about your organization..."></textarea>
                    <div class="flex items-center justify-between">
                      <p class="text-xs text-slate-500">
                        {{ getDescriptionWordCount() }} / 1000 words
                      </p>
                      <div class="flex items-center gap-2">
                        <button type="submit"
                          [disabled]="isSaving() || descriptionForm.invalid || getDescriptionWordCount() > 1000"
                          class="px-4 py-2 rounded-lg bg-green-500 text-white text-sm font-semibold hover:bg-green-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                          Save
                        </button>
                        <button type="button"
                          (click)="cancelEditingDescription()"
                          [disabled]="isSaving()"
                          class="px-4 py-2 rounded-lg bg-slate-200 text-slate-700 text-sm font-semibold hover:bg-slate-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                          Cancel
                        </button>
                      </div>
                    </div>
                    <p *ngIf="getDescriptionWordCount() > 1000" class="text-xs text-red-600">
                      Description must be 1000 words or less. Currently {{ getDescriptionWordCount() }} words.
                    </p>
                    <p *ngIf="descriptionForm.controls.description.invalid && descriptionForm.controls.description.touched && getDescriptionWordCount() <= 1000" class="text-xs text-red-600">
                      Description must be less than 10000 characters.
                    </p>
                  </form>
                </ng-template>
              </div>

              <!-- Error Message -->
              <div *ngIf="saveError()" class="mt-3 rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700">
                {{ saveError() }}
              </div>
            </div>
          </div>

        <!-- Join Organization Button / Already Member Badge (for open organizations) -->
        <div *ngIf="organization()?.allowOpenJoin === true && !isViewingOwnOrganization()" 
          class="mt-6 flex justify-center sm:justify-start">
          <!-- Join Button (if not a member) -->
          <button *ngIf="!isCurrentUserMember()"
            type="button"
            (click)="joinOrganization()"
            [disabled]="isJoiningOrganization()"
            class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-[#DC2626] to-[#B91C1C] text-white px-6 py-3 text-base font-bold shadow-lg hover:shadow-xl hover:shadow-red-500/40 hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
            <svg *ngIf="!isJoiningOrganization()" aria-hidden="true" viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
            </svg>
            <svg *ngIf="isJoiningOrganization()" aria-hidden="true" viewBox="0 0 24 24" class="h-5 w-5 animate-spin" fill="none" stroke="currentColor" stroke-width="2.5">
              <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2" opacity="0.25"></circle>
              <path d="M21 12a9 9 0 00-9-9" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
            </svg>
            <span>{{ isJoiningOrganization() ? 'Joining...' : 'Join Organization' }}</span>
          </button>
          <!-- Already Member Badge (if already a member) -->
          <div *ngIf="isCurrentUserMember()"
            class="inline-flex items-center gap-2 rounded-xl bg-slate-100 border-2 border-slate-300 px-6 py-3 text-base font-semibold text-slate-700">
            <svg aria-hidden="true" viewBox="0 0 24 24" class="h-5 w-5 text-green-600" fill="none" stroke="currentColor" stroke-width="2.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Already a member</span>
          </div>
        </div>
        <div *ngIf="joinOrganizationError()" class="mt-3 rounded-lg border border-red-200 bg-red-50 px-4 py-2 text-sm text-red-700 text-center sm:text-left">
          {{ joinOrganizationError() }}
        </div>
        <div *ngIf="joinOrganizationSuccess()" class="mt-3 rounded-lg border border-green-200 bg-green-50 px-4 py-2 text-sm text-green-700 text-center sm:text-left">
          {{ joinOrganizationSuccess() }}
        </div>

        <!-- Members & Invite Section -->
        <div *ngIf="isCreator() || canInviteMembers()" class="mt-8">
          <button type="button" 
            (click)="toggleMembersSection()"
            class="flex items-center justify-between w-full text-left mb-4 p-4 rounded-xl border-2 border-slate-200 bg-white hover:border-[#DC2626]/30 transition-all duration-200 group">
            <h3 class="text-xl font-bold text-slate-900">Members & Invites</h3>
            <svg aria-hidden="true" viewBox="0 0 24 24" 
              class="h-5 w-5 text-slate-400 group-hover:text-slate-600 transition-transform duration-200"
              [class.rotate-180]="membersSectionExpanded()">
              <path d="M19 9l-7 7-7-7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>

          <div *ngIf="membersSectionExpanded()" class="rounded-xl border-2 border-slate-200 bg-white shadow-sm overflow-hidden">
            <!-- Members List -->
            <div *ngIf="isCreator()" class="border-b border-slate-200">
              <button type="button"
                (click)="toggleMembersList()"
                class="w-full flex items-center justify-between px-6 py-4 hover:bg-slate-50 transition-colors group">
                <div class="flex items-center gap-3">
                  <svg aria-hidden="true" viewBox="0 0 24 24" class="h-5 w-5 text-slate-500">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <circle cx="9" cy="7" r="4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M16 3.13a4 4 0 0 1 0 7.75" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                  <span class="font-semibold text-slate-900">Members ({{ organizationMembers().length }})</span>
                </div>
                <svg aria-hidden="true" viewBox="0 0 24 24" 
                  class="h-4 w-4 text-slate-400 group-hover:text-slate-600 transition-transform duration-200"
                  [class.rotate-180]="membersListExpanded()">
                  <path d="M19 9l-7 7-7-7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              </button>
              
              <div *ngIf="membersListExpanded()" class="px-6 pb-4">
                <ng-container *ngIf="isLoadingMembers(); else membersList">
                  <div class="flex items-center justify-center py-8">
                    <svg aria-hidden="true" viewBox="0 0 24 24" class="h-6 w-6 animate-spin text-slate-400">
                      <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="1.6" opacity="0.25"></circle>
                      <path d="M21 12a9 9 0 00-9-9" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"></path>
                    </svg>
                  </div>
                </ng-container>
                <ng-template #membersList>
                  <ng-container *ngIf="organizationMembers().length > 0; else noMembers">
                    <div class="space-y-3">
                      <div *ngFor="let member of organizationMembers()"
                        class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-50 transition-colors">
                        <div class="flex-shrink-0">
                          <img *ngIf="member.profilePictureUrl" 
                            [src]="member.profilePictureUrl" 
                            [alt]="member.firstName + ' ' + member.lastName"
                            class="h-10 w-10 rounded-full object-cover border-2 border-slate-200" />
                          <div *ngIf="!member.profilePictureUrl"
                            class="h-10 w-10 rounded-full bg-gradient-to-br from-[#DC2626] to-[#B91C1C] flex items-center justify-center text-white text-sm font-bold border-2 border-slate-200">
                            {{ getMemberInitials(member) }}
                          </div>
                        </div>
                        <div class="flex-1 min-w-0">
                          <div class="flex items-center gap-2">
                            <p class="text-sm font-semibold text-slate-900 truncate">
                              {{ member.firstName }} {{ member.lastName }}
                            </p>
                            <span *ngIf="isMemberCreator(member)"
                              class="px-2 py-0.5 rounded-full bg-[#DC2626]/10 text-[#DC2626] text-xs font-semibold">
                              Creator
                            </span>
                            <span *ngIf="isMemberAdmin(member) && !isMemberCreator(member)"
                              class="px-2 py-0.5 rounded-full bg-blue-100 text-blue-700 text-xs font-semibold">
                              Admin
                            </span>
                          </div>
                          <p class="text-xs text-slate-500 truncate">
                            {{ member.username ? '@' + member.username : member.email }}
                          </p>
                        </div>
                        <div class="flex-shrink-0 flex items-center gap-1" *ngIf="isCreator() && !isMemberCreator(member)">
                          <!-- Make/Remove Admin Button -->
                          <button
                            *ngIf="!isMemberAdmin(member)"
                            (click)="makeAdmin(member)"
                            [disabled]="managingAdminId() === member.id"
                            class="p-1.5 rounded-lg text-blue-600 hover:bg-blue-50 hover:text-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            title="Make admin">
                            <svg *ngIf="managingAdminId() !== member.id" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <svg *ngIf="managingAdminId() === member.id" aria-hidden="true" viewBox="0 0 24 24" class="h-5 w-5 animate-spin text-blue-600">
                              <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="1.6" opacity="0.25"></circle>
                              <path d="M21 12a9 9 0 00-9-9" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"></path>
                            </svg>
                          </button>
                          <button
                            *ngIf="isMemberAdmin(member)"
                            (click)="removeAdmin(member)"
                            [disabled]="managingAdminId() === member.id"
                            class="p-1.5 rounded-lg text-blue-600 hover:bg-blue-50 hover:text-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            title="Remove admin">
                            <svg *ngIf="managingAdminId() !== member.id" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <svg *ngIf="managingAdminId() === member.id" aria-hidden="true" viewBox="0 0 24 24" class="h-5 w-5 animate-spin text-blue-600">
                              <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="1.6" opacity="0.25"></circle>
                              <path d="M21 12a9 9 0 00-9-9" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"></path>
                            </svg>
                          </button>
                          <!-- Remove Member Button -->
                          <button
                            (click)="removeMember(member)"
                            [disabled]="removingMemberId() === member.id"
                            class="p-1.5 rounded-lg text-red-600 hover:bg-red-50 hover:text-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            title="Remove member">
                            <svg *ngIf="removingMemberId() !== member.id" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            <svg *ngIf="removingMemberId() === member.id" aria-hidden="true" viewBox="0 0 24 24" class="h-5 w-5 animate-spin text-red-600">
                              <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="1.6" opacity="0.25"></circle>
                              <path d="M21 12a9 9 0 00-9-9" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"></path>
                            </svg>
                          </button>
                        </div>
                      </div>
                    </div>
                  </ng-container>
                  <ng-template #noMembers>
                    <p class="text-sm text-slate-500 text-center py-4">No members found.</p>
                  </ng-template>
                </ng-template>
                <p *ngIf="removeMemberError()" class="mt-3 text-sm text-red-600">
                  {{ removeMemberError() }}
                </p>
                <p *ngIf="adminManagementError()" class="mt-3 text-sm text-red-600">
                  {{ adminManagementError() }}
                </p>
              </div>
            </div>

            <!-- Invite Users Section -->
            <div *ngIf="canInviteMembers()" [class.border-t]="isCreator()">
              <button type="button"
                (click)="toggleInviteSection()"
                class="w-full flex items-center justify-between px-6 py-4 hover:bg-slate-50 transition-colors group">
                <div class="flex items-center gap-3">
                  <svg aria-hidden="true" viewBox="0 0 24 24" class="h-5 w-5 text-slate-500">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <circle cx="8.5" cy="7" r="4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M20 8v6M23 11h-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                  <span class="font-semibold text-slate-900">Invite Members</span>
                </div>
                <svg aria-hidden="true" viewBox="0 0 24 24" 
                  class="h-4 w-4 text-slate-400 group-hover:text-slate-600 transition-transform duration-200"
                  [class.rotate-180]="inviteSectionExpanded()">
                  <path d="M19 9l-7 7-7-7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              </button>

              <div *ngIf="inviteSectionExpanded()" class="px-6 pb-6">
                <div class="relative">
                  <label class="group relative flex w-full items-center rounded-xl bg-white border-2 border-black/10 shadow-md hover:border-[#DC2626]/30 transition-all duration-200">
                    <svg aria-hidden="true" viewBox="0 0 24 24"
                      class="mx-3 h-4 w-4 text-slate-400 group-focus-within:text-[#DC2626] transition-colors flex-shrink-0 md:mx-4 md:h-5 md:w-5">
                      <path d="M21 21l-4.35-4.35m1.68-4.83a6.51 6.51 0 11-13.02 0 6.51 6.51 0 0113.02 0z" fill="none"
                        stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <input type="text"
                      class="w-full min-w-0 rounded-xl bg-white py-2.5 pr-3 text-sm font-medium text-black placeholder:text-slate-400 focus:outline-none focus:border-[#DC2626] focus:ring-2 focus:ring-[#DC2626]/20 md:rounded-2xl md:py-3.5 md:pr-4 md:text-[15px]"
                      placeholder="Search by name, username, or email..." 
                      [value]="inviteQuery()" 
                      (input)="onInviteQueryChange(($any($event.target)).value)" />
                    <div *ngIf="isSearchingUsers()" class="absolute right-3 top-1/2 -translate-y-1/2">
                      <svg aria-hidden="true" viewBox="0 0 24 24" class="h-4 w-4 animate-spin text-slate-400">
                        <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="1.6" opacity="0.25"></circle>
                        <path d="M21 12a9 9 0 00-9-9" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"></path>
                      </svg>
                    </div>
                  </label>

                  <!-- Suggestions dropdown -->
                  <div *ngIf="inviteSuggestions().length > 0"
                    class="mt-2 rounded-xl bg-white border-2 border-slate-200 shadow-lg max-h-60 overflow-auto z-10">
                    <ul>
                      <li *ngFor="let user of inviteSuggestions()"
                        (click)="selectInviteSuggestion(user)"
                        class="cursor-pointer px-4 py-3 hover:bg-slate-50 border-b border-slate-100 last:border-b-0 transition-colors">
                        <div class="flex items-center gap-3">
                          <div class="flex-shrink-0">
                            <img *ngIf="user.profilePictureUrl" [src]="user.profilePictureUrl" [alt]="user.firstName + ' ' + user.lastName"
                              class="h-10 w-10 rounded-full object-cover" />
                            <div *ngIf="!user.profilePictureUrl"
                              class="h-10 w-10 rounded-full bg-gradient-to-br from-[#DC2626] to-[#B91C1C] flex items-center justify-center text-white text-sm font-bold">
                              {{ (user.firstName.charAt(0) || '') + (user.lastName.charAt(0) || '') || user.email.charAt(0) }}
                            </div>
                          </div>
                          <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold text-slate-900 truncate">
                              {{ user.firstName }} {{ user.lastName }}
                            </p>
                            <p class="text-xs text-slate-500 truncate">
                              {{ user.username ? '@' + user.username : user.email }}
                            </p>
                          </div>
                        </div>
                      </li>
                    </ul>
                  </div>

                  <!-- Invite by email option -->
                  <div *ngIf="inviteQuery() && inviteSuggestions().length === 0 && !isSearchingUsers()"
                    class="mt-2 rounded-xl bg-slate-50 border-2 border-slate-200 p-4">
                    <p class="text-sm text-slate-600 mb-3">User not found. Invite by email:</p>
                    <div class="flex gap-2">
                      <input type="email"
                        [value]="inviteQuery()"
                        class="flex-1 rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:border-[#DC2626] focus:ring-2 focus:ring-[#DC2626]/20"
                        placeholder="email@example.com"
                        (keydown.enter)="inviteByEmail(inviteQuery())" />
                      <button type="button"
                        (click)="inviteByEmail(inviteQuery())"
                        [disabled]="isInviting()"
                        class="px-4 py-2 rounded-lg bg-[#DC2626] text-white text-sm font-semibold hover:bg-[#B91C1C] transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <span *ngIf="!isInviting()">Invite</span>
                        <span *ngIf="isInviting()">Inviting...</span>
                      </button>
                    </div>
                  </div>

                  <!-- Error message -->
                  <div *ngIf="inviteError()" class="mt-2 rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700">
                    {{ inviteError() }}
                  </div>

                  <!-- Success message -->
                  <div *ngIf="inviteSuccess()" class="mt-2 rounded-lg border border-green-200 bg-green-50 px-3 py-2 text-sm text-green-700">
                    {{ inviteSuccess() }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Settings Section (Creator Only) -->
        <div *ngIf="isCreator()" class="mt-8">
          <button type="button" 
            (click)="toggleSettingsSection()"
            class="flex items-center justify-between w-full text-left mb-4 p-4 rounded-xl border-2 border-slate-200 bg-white hover:border-[#DC2626]/30 transition-all duration-200 group">
            <h3 class="text-xl font-bold text-slate-900">Settings</h3>
            <svg aria-hidden="true" viewBox="0 0 24 24" 
              class="h-5 w-5 text-slate-400 group-hover:text-slate-600 transition-transform duration-200"
              [class.rotate-180]="settingsSectionExpanded()">
              <path d="M19 9l-7 7-7-7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>

          <div *ngIf="settingsSectionExpanded()" class="rounded-xl border-2 border-slate-200 bg-white shadow-sm overflow-hidden p-6">
            <!-- Open Membership Toggle -->
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <h4 class="text-base font-semibold text-slate-900 mb-1">Allow Open Membership</h4>
                <p class="text-sm text-slate-600">
                  When enabled, anyone can join your organization without an invitation. They will appear in the "Organizations Welcoming Members" section.
                </p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer ml-4">
                <input type="checkbox" 
                  [checked]="organization()?.allowOpenJoin === true"
                  (change)="toggleOpenMembership($event)"
                  [disabled]="isSavingOpenMembership()"
                  class="sr-only peer" />
                <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-[#DC2626]/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#DC2626]"></div>
              </label>
            </div>
            <p *ngIf="openMembershipError()" class="mt-3 text-sm text-red-600">
              {{ openMembershipError() }}
            </p>
          </div>
        </div>

        <!-- Organization Prompts & Collections -->
        <div class="mt-12">
          <!-- TABS -->
          <section class="border-b-2 border-black/5 mb-6">
            <div class="flex gap-8">
              <button type="button" 
                class="profile-tab" 
                [class.profile-tab--active]="activeTab() === 'prompts'"
                (click)="selectTab('prompts')">
                <span>Prompts</span>
              </button>
              <button type="button" 
                class="profile-tab" 
                [class.profile-tab--active]="activeTab() === 'collections'"
                (click)="selectTab('collections')">
                <span>Collections</span>
              </button>
            </div>
          </section>

          <!-- PROMPTS TAB CONTENT -->
          <ng-container *ngIf="activeTab() === 'prompts'">
            <!-- Search Bar -->
            <div class="mb-6">
            <!-- Desktop search -->
            <div class="hidden sm:block w-full min-w-0">
              <label
                class="group relative flex w-full items-center rounded-xl bg-white border-2 border-black/10 shadow-md hover:border-[#DC2626]/30 transition-all duration-200 md:rounded-2xl min-w-0 max-w-full">
                <svg aria-hidden="true" viewBox="0 0 24 24"
                  class="mx-3 h-4 w-4 text-slate-400 group-focus-within:text-[#DC2626] transition-colors flex-shrink-0 md:mx-4 md:h-5 md:w-5">
                  <path d="M21 21l-4.35-4.35m1.68-4.83a6.51 6.51 0 11-13.02 0 6.51 6.51 0 0113.02 0z" fill="none"
                    stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <input type="search"
                  class="w-full min-w-0 rounded-xl bg-white py-2.5 pr-3 text-sm font-medium text-black placeholder:text-slate-400 focus:outline-none focus:border-[#DC2626] focus:ring-2 focus:ring-[#DC2626]/20 md:rounded-2xl md:py-3.5 md:pr-4 md:text-[15px]"
                  placeholder="Search prompts by title, tag..." 
                  [value]="searchTerm()" 
                  (input)="onSearch(($any($event.target)).value)" />
              </label>
            </div>

            <!-- Mobile search -->
            <div class="block sm:hidden w-full">
              <label
                class="group relative flex w-full items-center rounded-2xl bg-white border-2 border-black/10 shadow-md hover:border-[#DC2626]/30 transition-all duration-200">
                <svg aria-hidden="true" viewBox="0 0 24 24"
                  class="mx-4 h-5 w-5 text-slate-400 group-focus-within:text-[#DC2626] transition-colors">
                  <path d="M21 21l-4.35-4.35m1.68-4.83a6.51 6.51 0 11-13.02 0 6.51 6.51 0 0113.02 0z" fill="none"
                    stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <input type="search"
                  class="w-full rounded-2xl bg-white py-3.5 pr-4 text-[15px] font-medium text-black placeholder:text-slate-400 focus:outline-none focus:border-[#DC2626] focus:ring-2 focus:ring-[#DC2626]/20"
                  placeholder="Search prompts by title, tag..." 
                  [value]="searchTerm()" 
                  (input)="onSearch(($any($event.target)).value)" />
              </label>
            </div>
          </div>

          <section *ngIf="activeTab() === 'prompts'" class="mb-6">
            <div
              class="rounded-2xl border-2 border-[#DC2626]/20 bg-white/90 backdrop-blur-sm p-4 shadow-lg flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
              <div class="space-y-1">
                <p class="text-[10px] font-black uppercase tracking-widest text-[#DC2626]/80 sm:text-xs">Direct Launch</p>
                <p class="text-sm font-extrabold text-slate-900 sm:text-base">
                  Default chatbot: <span class="text-[#DC2626]">{{ getDefaultChatbotLabel() }}</span>
                </p>
                <p class="text-xs text-slate-500 sm:text-sm">Choose where the rocket button launches prompts.</p>
              </div>
              <div class="flex flex-wrap items-center gap-2">
                <button type="button" *ngFor="let bot of chatbotOptions"
                  class="chatbot-option inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold transition-all duration-200 sm:px-4 sm:py-2 sm:text-sm"
                  [ngClass]="defaultChatbot() === bot.id
                      ? 'border-[#DC2626] bg-[#DC2626] text-white shadow-lg shadow-red-500/30'
                      : 'border-black/10 bg-white text-slate-700 hover:border-[#DC2626]/40 hover:text-[#DC2626]'"
                  (click)="setDefaultChatbot(bot.id)" [attr.title]="bot.label" [attr.aria-label]="bot.label">
                  <span class="chatbot-option__icon-wrapper">
                    <img [src]="bot.icon" [alt]="bot.label + ' logo'" class="chatbot-option__icon" />
                  </span>
                  <span class="chatbot-option__label">{{ bot.label }}</span>
                </button>
              </div>
            </div>
          </section>
          
          <div *ngIf="loadPromptsError()"
            class="mb-4 rounded-xl border border-red-200 bg-red-50 px-3 py-3 text-xs text-red-700 shadow-sm sm:mb-6 sm:rounded-2xl sm:px-5 sm:py-4 sm:text-sm">
            {{ loadPromptsError() }}
          </div>

          <ng-container *ngIf="isLoadingPrompts(); else promptsList">
            <div class="grid gap-8 md:grid-cols-2 xl:grid-cols-3 w-full">
              <div *ngFor="let skeleton of [1, 2, 3]"
                class="rounded-3xl border-2 border-black/5 bg-white p-6 shadow-lg animate-pulse w-full max-w-full box-border">
                <div class="h-5 w-24 rounded-full bg-gradient-to-r from-slate-200 to-slate-100 sm:h-7 sm:w-28"></div>
                <div class="mt-4 h-5 w-3/4 rounded-lg bg-gradient-to-r from-slate-200 to-slate-100 sm:mt-5 sm:h-6"></div>
                <div class="mt-4 h-24 rounded-xl bg-gradient-to-br from-slate-100 to-slate-50 sm:mt-6 sm:h-28 sm:rounded-2xl"></div>
              </div>
            </div>
          </ng-container>

          <ng-template #promptsList>
            <ng-container *ngIf="filteredPrompts().length > 0; else noPrompts">
              <div class="grid gap-8 md:grid-cols-2 xl:grid-cols-3 w-full">
                <app-prompt-card
                  *ngFor="let prompt of filteredPrompts(); trackBy: trackPromptById"
                  [prompt]="promptToCard(prompt)"
                  [authorProfile]="getAuthorProfile(prompt.authorId)"
                  [organizationProfile]="prompt.organizationId ? organization() || undefined : undefined"
                  [isUrlCopied]="recentlyCopiedUrl().has(prompt.id)"
                  [showEditActions]="true"
                  [isDeleting]="deletingPromptId() === prompt.id"
                  [isSaving]="isSavingPrompt()"
                  [currentUserExists]="(currentUser$ | async) !== null"
                  [defaultChatbotLabel]="getDefaultChatbotLabel()"
                  [promptUrl]="getPromptUrl(prompt)"
                  [promptDisplayUrl]="getPromptDisplayUrl(prompt)"
                  [originalPromptUrl]="getOriginalPromptUrl(prompt)"
                  [canEdit]="canEditPrompt(prompt)"
                  (launchPrompt)="launchPrompt($any($event))"
                  (sharePrompt)="openShareModal($any($event))"
                  (forkPrompt)="openForkPromptModal($any($event))"
                  (openPrompt)="openPrompt($any($event))"
                  (editPrompt)="openEditPromptModal($any($event))"
                  (deletePrompt)="onDeletePrompt($any($event))"
                  (copyPromptUrl)="copyPromptUrl($any($event))"
                  (navigateToAuthor)="navigateToAuthorProfile($event.authorId, $event.event, prompt)"
                  (navigateToOrganization)="navigateToOrganization($event.organizationId, $event.event)"
                  (navigateToOriginalPrompt)="navigateToOriginalPrompt($any($event.prompt), $event.event)">
                </app-prompt-card>
              </div>
            </ng-container>

            <ng-template #noPrompts>
              <div class="rounded-2xl border-2 border-dashed border-slate-200 bg-slate-50 p-12 text-center">
                <div class="text-4xl mb-4">{{ searchTerm() ? '🔍' : '📝' }}</div>
                <p class="text-slate-500">{{ searchTerm() ? 'No prompts found matching your search.' : 'No prompts yet.' }}</p>
                <p class="text-sm text-slate-400 mt-2" *ngIf="isViewingOwnOrganization() && !searchTerm()">
                  Create your first prompt using the "New Prompt" button above.
                </p>
                <p class="text-sm text-slate-400 mt-2" *ngIf="searchTerm()">
                  Try a different search term or clear your search.
                </p>
              </div>
            </ng-template>
          </ng-template>
          </ng-container>

          <!-- COLLECTIONS TAB CONTENT -->
          <ng-container *ngIf="activeTab() === 'collections'">
            <div *ngIf="loadCollectionsError()"
              class="mb-4 rounded-xl border border-red-200 bg-red-50 px-3 py-3 text-xs text-red-700 shadow-sm sm:mb-6 sm:rounded-2xl sm:px-5 sm:py-4 sm:text-sm">
              {{ loadCollectionsError() }}
            </div>

            <ng-container *ngIf="isLoadingCollections(); else collectionsList">
              <div class="grid gap-8 md:grid-cols-2 xl:grid-cols-3 w-full">
                <div *ngFor="let skeleton of [1, 2, 3]"
                  class="rounded-3xl border-2 border-black/5 bg-white p-6 shadow-lg animate-pulse w-full max-w-full box-border">
                  <div class="h-48 -mx-6 -mt-6 rounded-t-3xl bg-gradient-to-br from-slate-100 to-slate-200"></div>
                  <div class="mt-4 h-5 w-24 rounded-full bg-gradient-to-r from-slate-200 to-slate-100 sm:h-7 sm:w-28"></div>
                  <div class="mt-4 h-5 w-3/4 rounded-lg bg-gradient-to-r from-slate-200 to-slate-100 sm:mt-5 sm:h-6"></div>
                </div>
              </div>
            </ng-container>

            <ng-template #collectionsList>
              <ng-container *ngIf="organizationCollections().length > 0; else noCollections">
                <div class="grid gap-8 md:grid-cols-2 xl:grid-cols-3 w-full">
                  <article *ngFor="let collection of organizationCollections()"
                    class="group flex h-full flex-col rounded-3xl border-2 border-black/5 bg-white p-6 shadow-lg transition-all duration-300 hover:shadow-2xl hover:shadow-red-500/10 hover:-translate-y-2 hover:border-[#DC2626]/20 w-full min-w-0 max-w-full overflow-hidden box-border">
                    
                    <!-- Hero Image or Placeholder -->
                    <div *ngIf="collection.heroImageUrl" 
                      class="mb-4 -mx-6 -mt-6 h-48 rounded-t-3xl overflow-hidden">
                      <img [src]="collection.heroImageUrl" 
                        [alt]="collection.name"
                        class="w-full h-full object-cover" />
                    </div>
                    <div *ngIf="!collection.heroImageUrl"
                      class="mb-4 -mx-6 -mt-6 h-48 rounded-t-3xl bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center">
                      <svg aria-hidden="true" viewBox="0 0 24 24" class="h-16 w-16 text-slate-400" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M3 9h18M9 21V9" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                    </div>

                    <!-- Tag -->
                    <span class="w-fit rounded-full bg-white border-2 border-[#DC2626]/30 px-3 py-1.5 text-xs font-bold capitalize text-[#DC2626] shadow-sm mb-3">
                      {{ formatTagLabel(collection.tag) }}
                    </span>

                    <!-- Collection Name -->
                    <h3 class="text-xl font-black tracking-tight text-black group-hover:text-[#DC2626] transition-colors duration-200 break-words overflow-wrap-anywhere leading-tight mb-2">
                      {{ collection.name }}
                    </h3>

                    <!-- Blurb -->
                    <p *ngIf="collection.blurb" class="text-sm text-slate-600 line-clamp-3 mb-4">
                      {{ collection.blurb }}
                    </p>

                    <!-- Prompt Count and Actions -->
                    <div class="mt-auto flex items-center justify-between pt-4 border-t border-slate-200">
                      <span class="text-sm text-slate-600">
                        <span class="font-semibold">{{ collection.promptIds.length }}</span>
                        {{ collection.promptIds.length === 1 ? 'prompt' : 'prompts' }}
                      </span>
                      <div class="flex items-center gap-2">
                        <button *ngIf="isViewingOwnOrganization()" 
                          type="button"
                          class="icon-button icon-button--primary"
                          aria-label="Edit collection"
                          title="Edit collection"
                          (click)="router.navigate(['/collections', collection.id]); $event.stopPropagation()">
                          <svg aria-hidden="true" viewBox="0 0 24 24" class="h-4 w-4">
                            <path d="M4 21h4l11-11-4-4L4 17v4z" fill="none" stroke="currentColor" stroke-width="1.6"
                              stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M15 6l3 3" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                              stroke-linejoin="round" />
                          </svg>
                        </button>
                        <button *ngIf="isViewingOwnOrganization()" 
                          type="button"
                          class="icon-button icon-button--danger"
                          aria-label="Delete collection"
                          title="Delete collection"
                          (click)="onDeleteCollection(collection); $event.stopPropagation()">
                          <svg aria-hidden="true" viewBox="0 0 24 24" class="h-4 w-4">
                            <path d="M3 6h18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                              stroke-linejoin="round" />
                            <path d="M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2" fill="none" stroke="currentColor" stroke-width="1.6"
                              stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6" fill="none" stroke="currentColor"
                              stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M10 11v6m4-6v6" fill="none" stroke="currentColor" stroke-width="1.6"
                              stroke-linecap="round" stroke-linejoin="round" />
                          </svg>
                        </button>
                        <button type="button"
                          class="icon-button"
                          aria-label="View collection"
                          title="View collection"
                          (click)="router.navigate(['/collections', collection.id]); $event.stopPropagation()">
                          <svg aria-hidden="true" viewBox="0 0 24 24" class="h-5 w-5 text-slate-400 group-hover:text-[#DC2626] transition-colors">
                            <path d="M9 5l7 7-7 7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                          </svg>
                        </button>
                      </div>
                    </div>
                  </article>
                </div>
              </ng-container>

              <ng-template #noCollections>
                <div class="rounded-2xl border-2 border-dashed border-slate-200 bg-slate-50 p-12 text-center">
                  <div class="text-4xl mb-4">📚</div>
                  <p class="text-slate-500">No collections yet.</p>
                </div>
              </ng-template>
            </ng-template>
          </ng-container>
        </div>
      </section>
    </ng-container>
    <ng-template #notFound>
      <div class="mx-auto max-w-6xl px-4 pt-16 sm:px-6 lg:px-8">
        <div class="rounded-2xl border-2 border-dashed border-slate-200 bg-slate-50 p-12 text-center">
          <div class="text-4xl mb-4">🔍</div>
          <p class="text-xl font-bold text-slate-900 mb-2">Organization not found</p>
          <p class="text-slate-500 mb-6">The organization you're looking for doesn't exist or has been removed.</p>
          <button type="button"
            (click)="router.navigate(['/organizations'])"
            class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-[#DC2626] to-[#B91C1C] text-white px-6 py-3 text-sm font-bold shadow-lg hover:shadow-xl hover:shadow-red-500/40 hover:scale-105 transition-all duration-200">
            Go to Organizations
          </button>
        </div>
      </div>
    </ng-template>
  </div>
</ng-container>

<!-- CREATE PROMPT MODAL -->
<div *ngIf="newPromptModalOpen()" class="modal-overlay" (click)="closeCreatePromptModal()">
  <div class="modal-card" (click)="$event.stopPropagation()">
    <button type="button" class="modal-close" aria-label="Close" (click)="closeCreatePromptModal()"
      [disabled]="isSavingPrompt()">
      <svg aria-hidden="true" viewBox="0 0 24 24" class="h-4 w-4">
        <path d="M18 6 6 18M6 6l12 12" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"
          stroke-linejoin="round" />
      </svg>
    </button>

    <header class="pr-6 sm:pr-8">
      <p class="text-xs font-semibold uppercase tracking-[0.2em] text-[#DC2626] sm:text-sm">
        {{ isEditingPrompt() ? 'Update' : forkingPromptId() ? 'Fork' : 'Create' }}
      </p>
      <h2 class="mt-1.5 text-lg font-semibold text-slate-900 sm:mt-2 sm:text-2xl">
        {{ isEditingPrompt() ? 'Edit Prompt' : forkingPromptId() ? 'Fork Prompt' : 'New Prompt' }}
      </h2>
      <p class="mt-1 text-xs text-slate-500 sm:text-sm">
        <ng-container *ngIf="isEditingPrompt()">
          Make adjustments and keep your library fresh.
        </ng-container>
        <ng-container *ngIf="forkingPromptId()">
          Start with this prompt and make it your own. You can edit the title, content, and tag.
        </ng-container>
        <ng-container *ngIf="!isEditingPrompt() && !forkingPromptId()">
          Create a prompt for your organization. This prompt will be associated with {{ organization()?.name }}.
        </ng-container>
      </p>
      <div *ngIf="forkingPromptId()"
        class="mt-3 rounded-lg bg-purple-50 border border-purple-200/50 px-3 py-2 text-xs text-purple-800">
        <span class="font-semibold">Forking:</span>
        <span class="ml-1">{{ getForkingPromptTitle() }}</span>
      </div>
    </header>

    <app-prompt-form
      [initialData]="promptFormInitialData()"
      [isEditing]="isEditingPrompt()"
      [editingPromptId]="editingPromptId()"
      [forkingPromptId]="forkingPromptId()"
      [forkingPromptTitle]="getForkingPromptTitle()"
      [canManagePrivate]="(currentUserProfile()?.role === 'admin' || currentUserProfile()?.admin) ?? false"
      [tagSuggestions]="[]"
      [customUrlError]="customUrlError()"
      [isCheckingCustomUrl]="isCheckingCustomUrl()"
      [promptFormError]="promptFormError()"
      [isSaving]="isSavingPrompt()"
      (formSubmit)="onPromptFormSubmit($event)"
      (formCancel)="onPromptFormCancel()"
      (tagInput)="onPromptFormTagInput($event)"
      (customUrlInput)="onPromptFormCustomUrlInput($event)">
    </app-prompt-form>
  </div>
</div>

<!-- CREATE COLLECTION MODAL -->
<app-collection-modal
  [isOpen]="newCollectionModalOpen()"
  [isSaving]="isSavingCollection()"
  [form]="createCollectionForm"
  title="New Collection"
  [description]="organization()?.name ? 'Create a collection for ' + organization()?.name + '. This collection will be associated with your organization.' : 'Create a collection for your organization.'"
  customUrlPrefix="rocketprompt.io/collection/"
  [customUrlError]="collectionCustomUrlError()"
  [isCheckingCustomUrl]="isCheckingCollectionCustomUrl()"
  [promptSearchTerm]="collectionPromptSearchTerm()"
  promptSearchPlaceholder="Search prompts by title or tag..."
  [showPromptSearch]="!isLoadingPrompts() && !loadPromptsError() && organizationPrompts().length > 0"
  [prompts]="organizationPromptOptions()"
  [selectedPromptIds]="createCollectionForm.controls.promptIds.value"
  [chatbotOptions]="chatbotOptions"
  [defaultAi]="collectionDefaultAi()"
  [isLoadingPrompts]="isLoadingPrompts()"
  [promptLoadError]="loadPromptsError()"
  [enableBranding]="true"
  [brandingSectionExpanded]="brandingSectionExpanded()"
  brandSectionDescription="Add your company logo, link, and a short description to brand this collection."
  [brandLogoUrl]="brandLogoUrl()"
  [uploadingBrandLogo]="uploadingBrandLogo()"
  [brandLogoUploadError]="brandLogoUploadError()"
  [brandSubtextWordCount]="brandSubtextWordCount()"
  [formError]="collectionFormError()"
  [disableSubmit]="organizationPrompts().length === 0 || brandSubtextWordCount() > 50"
  submitButtonLabel="Save Collection"
  cancelButtonLabel="Cancel"
  noPromptsTitle="No prompts found"
  noPromptsDescription="Create prompts first to build a collection."
  (close)="closeCreateCollectionModal()"
  (formSubmit)="submitCollectionForm()"
  (customUrlInput)="onCollectionCustomUrlInput($event)"
  (promptSearchChange)="collectionPromptSearchTerm.set($event)"
  (promptSearchCleared)="collectionPromptSearchTerm.set('')"
  (promptSelectionToggle)="togglePromptSelection($event)"
  (defaultAiChange)="setCollectionDefaultAi($event)"
  (brandLogoSelected)="onBrandLogoSelected($event)"
  (brandLogoRemoved)="removeBrandLogo()"
  (toggleBrandingSection)="brandingSectionExpanded.set(!brandingSectionExpanded())"
></app-collection-modal>

<!-- SHARE PROMPT MODAL -->
<app-share-modal 
  [isOpen]="shareModalOpen()" 
  [prompt]="sharePrompt() ? { id: sharePrompt()!.id, title: sharePrompt()!.title, content: sharePrompt()!.content, preview: buildPreview(sharePrompt()!.content || ''), customUrl: sharePrompt()!.customUrl } : null"
  (close)="closeShareModal()"
  (copyOneClickLink)="copyOneClickLink($event)"
  (openChatbot)="handleOpenChatbot($event)"
  (copyPromptUrl)="copyPromptPageUrl()"
  (copyPrompt)="copyPromptFromShare()">
</app-share-modal>

<ng-template #loading>
  <div role="status" aria-live="polite"
    class="fixed inset-0 z-50 flex items-center justify-center bg-white text-slate-900">
    <div class="w-full max-w-sm px-6 py-8 text-center">
      <div class="mx-auto mb-6 h-12 w-12 animate-spin rounded-full border-4 border-slate-200 border-t-[#DC2626]"></div>
      <p class="text-xl font-semibold">Loading…</p>
      <p class="mt-2 text-sm opacity-80">Preparing organization profile</p>
    </div>
  </div>
</ng-template>
